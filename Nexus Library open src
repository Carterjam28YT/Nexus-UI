-- Nexus UI Library with Auto-Positioning, Key System, Draggable UI & UI Components
local NexusUI = {}
NexusUI.__index = NexusUI

-- Services
local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")
local TextService = game:GetService("TextService")

-- Colors
NexusUI.Colors = {
    Primary = Color3.fromRGB(99, 102, 241),
    PrimaryDark = Color3.fromRGB(79, 70, 229),
    Secondary = Color3.fromRGB(168, 85, 247),
    Discord = Color3.fromRGB(88, 101, 242),
    Dark = Color3.fromRGB(30, 41, 59),
    Darker = Color3.fromRGB(15, 23, 42),
    Light = Color3.fromRGB(248, 250, 252),
    GrayLight = Color3.fromRGB(203, 213, 225),
    Gray = Color3.fromRGB(148, 163, 184),
    Success = Color3.fromRGB(16, 185, 129),
    Warning = Color3.fromRGB(245, 158, 11),
    Error = Color3.fromRGB(239, 68, 68),
    Info = Color3.fromRGB(59, 130, 246)
}

-- Animations
NexusUI.Animations = {
    ButtonHover = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
    ButtonClick = TweenInfo.new(0.1, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
    FadeIn = TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
    FadeOut = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
    SlideIn = TweenInfo.new(0.4, Enum.EasingStyle.Quart, Enum.EasingDirection.Out),
    SlideOut = TweenInfo.new(0.3, Enum.EasingStyle.Quart, Enum.EasingDirection.Out),
    Bounce = TweenInfo.new(0.5, Enum.EasingStyle.Bounce, Enum.EasingDirection.Out)
}

-- Built-in positioning system
NexusUI.Positions = {
    TopLeft = UDim2.new(0, 20, 0, 20),
    TopCenter = UDim2.new(0.5, -300, 0, 20),
    TopRight = UDim2.new(1, -620, 0, 20),
    CenterLeft = UDim2.new(0, 20, 0.5, -200),
    Center = UDim2.new(0.5, -300, 0.5, -200),
    CenterRight = UDim2.new(1, -620, 0.5, -200),
    BottomLeft = UDim2.new(0, 20, 1, -420),
    BottomCenter = UDim2.new(0.5, -300, 1, -420),
    BottomRight = UDim2.new(1, -620, 1, -420)
}

-- Default configuration
NexusUI.DefaultConfig = {
    Theme = "Dark",
    AnimationEnabled = true,
    SoundEnabled = false,
    AutoSavePosition = true,
    RoundCorners = true,
    SaveKey = "NexusUI_Data",
    DefaultPosition = "Center"
}

-- Initialize NexusUI
function NexusUI:Init(options)
    local self = setmetatable({}, NexusUI)
    
    -- Merge options with defaults
    self.options = setmetatable(options or {}, {__index = NexusUI.DefaultConfig})
    self.Parent = options.Parent or CoreGui
    self.Components = {}
    self.Windows = {}
    self.Verified = false
    self.KeySystemEnabled = options.KeySystem or false
    self.Keys = options.Keys or {"NEXUS-KEY-123"}
    self.GetKeyLink = options.GetKeyLink or "https://example.com/getkey"
    self.KeyWhitelist = options.KeyWhitelist or {}
    self.SavedData = {}
    self.WindowCounter = 0
    
    -- Load saved data
    self:LoadData()
    
    return self
end

-- Data persistence
function NexusUI:SaveData()
    if self.options.AutoSavePosition then
        pcall(function()
            local data = HttpService:JSONEncode(self.SavedData)
            -- Save implementation here
        end)
    end
end

function NexusUI:LoadData()
    self.SavedData = {
        WindowPositions = {},
        Settings = {},
        Verified = false
    }
end

function NexusUI:SaveWindowPosition(windowName, position)
    if not self.SavedData.WindowPositions then
        self.SavedData.WindowPositions = {}
    end
    self.SavedData.WindowPositions[windowName] = {
        X = {Scale = position.X.Scale, Offset = position.X.Offset},
        Y = {Scale = position.Y.Scale, Offset = position.Y.Offset}
    }
    self:SaveData()
end

function NexusUI:LoadWindowPosition(windowName, defaultPosition)
    if self.SavedData.WindowPositions and self.SavedData.WindowPositions[windowName] then
        local pos = self.SavedData.WindowPositions[windowName]
        return UDim2.new(pos.X.Scale, pos.X.Offset, pos.Y.Scale, pos.Y.Offset)
    end
    return defaultPosition
end

-- Smart positioning system
function NexusUI:GetSmartPosition(positionOption, windowIndex)
    if type(positionOption) == "string" then
        -- Use built-in position
        if NexusUI.Positions[positionOption] then
            local basePos = NexusUI.Positions[positionOption]
            if windowIndex > 1 then
                -- Offset multiple windows to avoid overlapping
                local offset = (windowIndex - 1) * 30
                return UDim2.new(
                    basePos.X.Scale, 
                    basePos.X.Offset + offset,
                    basePos.Y.Scale, 
                    basePos.Y.Offset + offset
                )
            end
            return basePos
        else
            warn("[NexusUI] Unknown position: " .. positionOption .. ", using Center")
            return NexusUI.Positions.Center
        end
    elseif typeof(positionOption) == "UDim2" then
        -- Use custom UDim2 position
        return positionOption
    else
        -- Use default position with smart offset
        local defaultPos = NexusUI.Positions[self.options.DefaultPosition]
        local offset = (windowIndex - 1) * 30
        return UDim2.new(
            defaultPos.X.Scale, 
            defaultPos.X.Offset + offset,
            defaultPos.Y.Scale, 
            defaultPos.Y.Offset + offset
        )
    end
end

-- Utility to create elements
function NexusUI:CreateElement(className, props, children)
    local success, element = pcall(function()
        local e = Instance.new(className)
        if props then
            for k, v in pairs(props) do
                if k ~= "Parent" then
                    e[k] = v
                end
            end
        end
        if children then
            for _, child in ipairs(children) do
                child.Parent = e
            end
        end
        if props and props.Parent then
            e.Parent = props.Parent
        end
        return e
    end)
    if not success then
        warn(`[NexusUI] Failed to create element: {className}`)
        return nil
    end
    return element
end

-- Enhanced draggable window system
function NexusUI:MakeDraggable(frame, dragHandle, windowName)
    dragHandle = dragHandle or frame
    local dragging = false
    local dragInput, dragStart, startPos
    
    local function Update(input)
        local delta = input.Position - dragStart
        local newPosition = UDim2.new(
            startPos.X.Scale, 
            startPos.X.Offset + delta.X,
            startPos.Y.Scale, 
            startPos.Y.Offset + delta.Y
        )
        frame.Position = newPosition
        if self.options.AutoSavePosition and windowName then
            self:SaveWindowPosition(windowName, newPosition)
        end
    end
    
    dragHandle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    dragHandle.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement and dragging then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            Update(input)
        end
    end)
end

-- Validate key
function NexusUI:ValidateKey(key)
    if not key or type(key) ~= "string" then return false end
    key = key:gsub("%s+", "")
    for _, validKey in ipairs(self.Keys) do
        if key == validKey then
            self.Verified = true
            self.SavedData.Verified = true
            self:SaveData()
            return true
        end
    end
    return false
end

-- Key System GUI
function NexusUI:CreateKeySystem(getKeyLink)
    getKeyLink = getKeyLink or self.GetKeyLink
    local gui = self:CreateElement("ScreenGui", {
        Parent = self.Parent, Name = "NexusKeySystem", IgnoreGuiInset = true
    })
    
    local background = self:CreateElement("Frame", {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundColor3 = Color3.new(0, 0, 0),
        BackgroundTransparency = 0.3, Parent = gui
    })
    
    local frame = self:CreateElement("Frame", {
        Size = UDim2.new(0, 450, 0, 280),
        Position = self.Positions.Center,
        BackgroundColor3 = self.Colors.Darker, Parent = gui
    }, {
        self:CreateElement("UICorner", {CornerRadius = UDim.new(0, 16)}),
        self:CreateElement("UIStroke", {Color = self.Colors.Primary, Thickness = 2})
    })
    
    -- Key system UI elements...
    local title = self:CreateElement("TextLabel", {
        Size = UDim2.new(1, -40, 0, 60), Position = UDim2.new(0, 20, 0, 0),
        Text = "üîê NEXUS UI - ACCESS REQUIRED", TextColor3 = self.Colors.Light,
        Font = Enum.Font.GothamBold, TextSize = 22, BackgroundTransparency = 1, Parent = frame
    })
    
    local keyBox = self:CreateElement("TextBox", {
        Size = UDim2.new(1, -40, 0, 45), Position = UDim2.new(0, 20, 0, 100),
        BackgroundColor3 = self.Colors.Dark, TextColor3 = self.Colors.Light,
        PlaceholderText = "Enter your key here...", Font = Enum.Font.Gotham,
        TextSize = 16, Parent = frame
    }, {
        self:CreateElement("UICorner", {CornerRadius = UDim.new(0, 8)})
    })
    
    local submit = self:CreateElement("TextButton", {
        Size = UDim2.new(0.5, -5, 0, 40), Position = UDim2.new(0, 20, 1, -70),
        BackgroundColor3 = self.Colors.Primary, Text = "VERIFY KEY",
        TextColor3 = self.Colors.Light, Font = Enum.Font.GothamBold, Parent = frame
    }, {
        self:CreateElement("UICorner", {CornerRadius = UDim.new(0, 8)})
    })
    
    self:MakeDraggable(frame, title)
    self:ApplyButtonEffects(submit)
    
    submit.MouseButton1Click:Connect(function()
        if self:ValidateKey(keyBox.Text) then
            self:PlaySuccessAnimation(frame)
            task.wait(0.5)
            gui:Destroy()
        else
            self:PlayErrorAnimation(keyBox)
            keyBox.Text = ""
            keyBox.PlaceholderText = "Invalid key!"
        end
    end)
    
    table.insert(self.Components, gui)
    return gui
end

-- UI COMPONENTS SECTION --

-- Create Button with various styles
function NexusUI:CreateButton(parent, options)
    options = options or {}
    local button = self:CreateElement("TextButton", {
        Size = options.Size or UDim2.new(0, 200, 0, 40),
        Position = options.Position or UDim2.new(0.5, -100, 0, 20),
        BackgroundColor3 = options.Color or self.Colors.Primary,
        Text = options.Text or "Button",
        TextColor3 = options.TextColor or self.Colors.Light,
        Font = Enum.Font.GothamBold,
        TextSize = options.TextSize or 14,
        Parent = parent
    }, {
        self:CreateElement("UICorner", {CornerRadius = UDim.new(0, 8)}),
        self:CreateElement("UIStroke", {
            Color = self:DarkenColor(options.Color or self.Colors.Primary, 0.3),
            Thickness = 2
        })
    })
    
    self:ApplyButtonEffects(button)
    
    if options.Callback then
        button.MouseButton1Click:Connect(options.Callback)
    end
    
    return button
end

-- Create Toggle Switch
function NexusUI:CreateToggle(parent, options)
    options = options or {}
    local toggleState = options.Default or false
    
    local toggleFrame = self:CreateElement("Frame", {
        Size = options.Size or UDim2.new(0, 60, 0, 30),
        Position = options.Position or UDim2.new(0, 20, 0, 20),
        BackgroundColor3 = toggleState and (options.Color or self.Colors.Success) or self.Colors.Gray,
        Parent = parent
    }, {
        self:CreateElement("UICorner", {CornerRadius = UDim.new(1, 0)})
    })
    
    local toggleButton = self:CreateElement("Frame", {
        Size = UDim2.new(0, 24, 0, 24),
        Position = toggleState and UDim2.new(1, -27, 0.5, -12) or UDim2.new(0, 3, 0.5, -12),
        BackgroundColor3 = self.Colors.Light,
        Parent = toggleFrame
    }, {
        self:CreateElement("UICorner", {CornerRadius = UDim.new(1, 0)})
    })
    
    local toggleLabel = self:CreateElement("TextLabel", {
        Size = UDim2.new(0, 200, 0, 30),
        Position = UDim2.new(1, 10, 0, 0),
        Text = options.Text or "Toggle",
        TextColor3 = self.Colors.Light,
        Font = Enum.Font.Gotham,
        TextSize = 14,
        BackgroundTransparency = 1,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = toggleFrame
    })
    
    local function updateToggle()
        self:Tween(toggleFrame, self.Animations.ButtonClick, {
            BackgroundColor3 = toggleState and (options.Color or self.Colors.Success) or self.Colors.Gray
        })
        self:Tween(toggleButton, self.Animations.ButtonClick, {
            Position = toggleState and UDim2.new(1, -27, 0.5, -12) or UDim2.new(0, 3, 0.5, -12)
        })
    end
    
    toggleFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            toggleState = not toggleState
            updateToggle()
            if options.Callback then
                options.Callback(toggleState)
            end
        end
    end)
    
    self:ApplyButtonEffects(toggleFrame)
    
    return {
        Frame = toggleFrame,
        SetState = function(state)
            toggleState = state
            updateToggle()
        end,
        GetState = function() return toggleState end
    }
end

-- Create Slider
function NexusUI:CreateSlider(parent, options)
    options = options or {}
    local min = options.Min or 0
    local max = options.Max or 100
    local current = options.Default or min
    
    local sliderContainer = self:CreateElement("Frame", {
        Size = options.Size or UDim2.new(0, 300, 0, 60),
        Position = options.Position or UDim2.new(0, 20, 0, 60),
        BackgroundTransparency = 1,
        Parent = parent
    })
    
    local sliderLabel = self:CreateElement("TextLabel", {
        Size = UDim2.new(1, 0, 0, 20),
        Text = options.Text or "Slider: " .. current,
        TextColor3 = self.Colors.Light,
        Font = Enum.Font.Gotham,
        TextSize = 14,
        BackgroundTransparency = 1,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = sliderContainer
    })
    
    local sliderTrack = self:CreateElement("Frame", {
        Size = UDim2.new(1, 0, 0, 6),
        Position = UDim2.new(0, 0, 0, 30),
        BackgroundColor3 = self.Colors.Dark,
        Parent = sliderContainer
    }, {
        self:CreateElement("UICorner", {CornerRadius = UDim.new(1, 0)})
    })
    
    local sliderFill = self:CreateElement("Frame", {
        Size = UDim2.new((current - min) / (max - min), 0, 1, 0),
        BackgroundColor3 = options.Color or self.Colors.Primary,
        Parent = sliderTrack
    }, {
        self:CreateElement("UICorner", {CornerRadius = UDim.new(1, 0)})
    })
    
    local sliderButton = self:CreateElement("TextButton", {
        Size = UDim2.new(0, 20, 0, 20),
        Position = UDim2.new((current - min) / (max - min), -10, 0.5, -10),
        BackgroundColor3 = self.Colors.Light,
        Text = "",
        Parent = sliderTrack
    }, {
        self:CreateElement("UICorner", {CornerRadius = UDim.new(1, 0)}),
        self:CreateElement("UIStroke", {
            Color = options.Color or self.Colors.Primary,
            Thickness = 2
        })
    })
    
    local function updateSlider(value)
        current = math.clamp(value, min, max)
        local fillWidth = (current - min) / (max - min)
        sliderFill.Size = UDim2.new(fillWidth, 0, 1, 0)
        sliderButton.Position = UDim2.new(fillWidth, -10, 0.5, -10)
        sliderLabel.Text = options.Text or "Slider: " .. math.floor(current)
        
        if options.Callback then
            options.Callback(current)
        end
    end
    
    local dragging = false
    sliderButton.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
        end
    end)
    
    sliderButton.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
    
    sliderTrack.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            local relativeX = input.Position.X - sliderTrack.AbsolutePosition.X
            local percentage = relativeX / sliderTrack.AbsoluteSize.X
            updateSlider(min + percentage * (max - min))
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local relativeX = input.Position.X - sliderTrack.AbsolutePosition.X
            local percentage = math.clamp(relativeX / sliderTrack.AbsoluteSize.X, 0, 1)
            updateSlider(min + percentage * (max - min))
        end
    end)
    
    return {
        Container = sliderContainer,
        SetValue = updateSlider,
        GetValue = function() return current end
    }
end

-- Create Label
function NexusUI:CreateLabel(parent, options)
    options = options or {}
    return self:CreateElement("TextLabel", {
        Size = options.Size or UDim2.new(1, -40, 0, 30),
        Position = options.Position or UDim2.new(0, 20, 0, 20),
        Text = options.Text or "Label",
        TextColor3 = options.Color or self.Colors.Light,
        Font = options.Font or Enum.Font.Gotham,
        TextSize = options.TextSize or 14,
        BackgroundTransparency = 1,
        TextXAlignment = options.Alignment or Enum.TextXAlignment.Left,
        TextWrapped = true,
        Parent = parent
    })
end

-- Create TextBox
function NexusUI:CreateTextBox(parent, options)
    options = options or {}
    return self:CreateElement("TextBox", {
        Size = options.Size or UDim2.new(1, -40, 0, 40),
        Position = options.Position or UDim2.new(0, 20, 0, 60),
        BackgroundColor3 = self.Colors.Dark,
        TextColor3 = self.Colors.Light,
        PlaceholderText = options.Placeholder or "Enter text...",
        PlaceholderColor3 = self.Colors.Gray,
        Text = options.Text or "",
        Font = Enum.Font.Gotham,
        TextSize = 14,
        ClearTextOnFocus = options.ClearOnFocus or false,
        Parent = parent
    }, {
        self:CreateElement("UICorner", {CornerRadius = UDim.new(0, 8)}),
        self:CreateElement("UIStroke", {
            Color = self.Colors.Gray,
            Thickness = 1
        })
    })
end

-- Create Dropdown
function NexusUI:CreateDropdown(parent, options)
    options = options or {}
    local items = options.Items or {"Option 1", "Option 2", "Option 3"}
    local selected = options.Default or items[1]
    local isOpen = false
    
    local dropdown = self:CreateElement("Frame", {
        Size = options.Size or UDim2.new(0, 200, 0, 40),
        Position = options.Position or UDim2.new(0, 20, 0, 100),
        BackgroundColor3 = self.Colors.Dark,
        ClipsDescendants = true,
        Parent = parent
    }, {
        self:CreateElement("UICorner", {CornerRadius = UDim.new(0, 8)}),
        self:CreateElement("UIStroke", {
            Color = self.Colors.Gray,
            Thickness = 1
        })
    })
    
    local selectedLabel = self:CreateElement("TextLabel", {
        Size = UDim2.new(1, -30, 1, 0),
        Position = UDim2.new(0, 10, 0, 0),
        Text = selected,
        TextColor3 = self.Colors.Light,
        Font = Enum.Font.Gotham,
        TextSize = 14,
        BackgroundTransparency = 1,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = dropdown
    })
    
    local arrow = self:CreateElement("TextLabel", {
        Size = UDim2.new(0, 20, 1, 0),
        Position = UDim2.new(1, -25, 0, 0),
        Text = "‚ñº",
        TextColor3 = self.Colors.Gray,
        Font = Enum.Font.Gotham,
        TextSize = 12,
        BackgroundTransparency = 1,
        Parent = dropdown
    })
    
    local optionsFrame = self:CreateElement("Frame", {
        Size = UDim2.new(1, 0, 0, 0),
        Position = UDim2.new(0, 0, 1, 5),
        BackgroundColor3 = self.Colors.Darker,
        Visible = false,
        Parent = dropdown
    }, {
        self:CreateElement("UICorner", {CornerRadius = UDim.new(0, 8)}),
        self:CreateElement("UIStroke", {
            Color = self.Colors.Gray,
            Thickness = 1
        })
    })
    
    local function toggleDropdown()
        isOpen = not isOpen
        optionsFrame.Visible = isOpen
        self:Tween(optionsFrame, self.Animations.SlideIn, {
            Size = isOpen and UDim2.new(1, 0, 0, #items * 30) or UDim2.new(1, 0, 0, 0)
        })
        arrow.Text = isOpen and "‚ñ≤" or "‚ñº"
    end
    
    local function selectItem(item)
        selected = item
        selectedLabel.Text = item
        toggleDropdown()
        if options.Callback then
            options.Callback(item)
        end
    end
    
    -- Create option buttons
    for i, item in ipairs(items) do
        local option = self:CreateElement("TextButton", {
            Size = UDim2.new(1, 0, 0, 30),
            Position = UDim2.new(0, 0, 0, (i-1)*30),
            BackgroundColor3 = self.Colors.Darker,
            Text = item,
            TextColor3 = self.Colors.Light,
            Font = Enum.Font.Gotham,
            TextSize = 14,
            Parent = optionsFrame
        })
        
        option.MouseButton1Click:Connect(function()
            selectItem(item)
        end)
        
        self:ApplyButtonEffects(option)
    end
    
    dropdown.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            toggleDropdown()
        end
    end)
    
    return {
        Frame = dropdown,
        GetSelected = function() return selected end,
        SetSelected = selectItem
    }
end

-- Discord Button
function NexusUI:CreateDiscordButton(parent, discordLink, options)
    options = options or {}
    discordLink = discordLink or "https://discord.gg/example"
    
    local discordBtn = self:CreateElement("TextButton", {
        Size = options.Size or UDim2.new(0, 120, 0, 35),
        Position = options.Position or UDim2.new(1, -130, 1, -45),
        BackgroundColor3 = self.Colors.Discord,
        Text = options.Text or "üì± Discord",
        TextColor3 = self.Colors.Light,
        Font = Enum.Font.GothamBold,
        TextSize = options.TextSize or 12,
        Parent = parent
    }, {
        self:CreateElement("UICorner", {CornerRadius = UDim.new(0, 6)}),
        self:CreateElement("UIStroke", {
            Color = self:DarkenColor(self.Colors.Discord, 0.3),
            Thickness = 1
        })
    })
    
    self:ApplyButtonEffects(discordBtn)
    
    discordBtn.MouseButton1Click:Connect(function()
        if pcall(function() setclipboard(discordLink) end) then
            local originalText = discordBtn.Text
            discordBtn.Text = "üìã Copied!"
            if self.options.AnimationEnabled then
                self:PlaySuccessAnimation(discordBtn)
            end
            task.wait(1.5)
            discordBtn.Text = originalText
        end
    end)
    
    return discordBtn
end

-- Apply button effects
function NexusUI:ApplyButtonEffects(button)
    local originalSize = button.Size
    local originalColor = button.BackgroundColor3
    
    button.MouseEnter:Connect(function()
        if self.options.AnimationEnabled then
            self:Tween(button, self.Animations.ButtonHover, {
                BackgroundColor3 = self:DarkenColor(originalColor, 0.2)
            })
        end
    end)
    
    button.MouseLeave:Connect(function()
        if self.options.AnimationEnabled then
            self:Tween(button, self.Animations.ButtonHover, {
                BackgroundColor3 = originalColor
            })
        end
    end)
    
    button.MouseButton1Down:Connect(function()
        if self.options.AnimationEnabled then
            self:Tween(button, self.Animations.ButtonClick, {
                Size = originalSize - UDim2.new(0, 4, 0, 4)
            })
        end
    end)
    
    button.MouseButton1Up:Connect(function()
        if self.options.AnimationEnabled then
            self:Tween(button, self.Animations.ButtonClick, {
                Size = originalSize
            })
        end
    end)
end

-- Create Main Window with auto-positioning
function NexusUI:CreateWindow(options)
    options = options or {}
    
    if self.KeySystemEnabled and not self.Verified then
        local windowData = {Options = options, OnVerified = function()
            self:CreateWindow(options)
        end}
        table.insert(self.Windows, windowData)
        self:CreateKeySystem()
        return windowData
    end
    
    self.WindowCounter = self.WindowCounter + 1
    local window = {Tabs = {}, Elements = {}}
    local guiName = options.Name or "NexusUI_" .. self.WindowCounter
    
    local gui = self:CreateElement("ScreenGui", {
        Parent = self.Parent, Name = guiName, IgnoreGuiInset = true
    })
    
    -- Use smart positioning
    local defaultPos = self:GetSmartPosition(options.Position or self.options.DefaultPosition, self.WindowCounter)
    local savedPosition = self:LoadWindowPosition(guiName, defaultPos)
    
    local frame = self:CreateElement("Frame", {
        Size = options.Size or UDim2.new(0, 500, 0, 400),
        Position = savedPosition,
        BackgroundColor3 = self.Colors.Darker, Parent = gui
    }, {
        self:CreateElement("UICorner", {CornerRadius = UDim.new(0, 12)}),
        self:CreateElement("UIStroke", {Color = self.Colors.Primary, Thickness = 2})
    })
    
    -- Title bar
    local titleBar = self:CreateElement("Frame", {
        Size = UDim2.new(1, 0, 0, 40), BackgroundColor3 = self.Colors.Dark, Parent = frame
    }, {
        self:CreateElement("UICorner", {CornerRadius = UDim.new(0, 12, 0, 0)})
    })
    
    local title = self:CreateElement("TextLabel", {
        Size = UDim2.new(1, -80, 1, 0), Position = UDim2.new(0, 15, 0, 0),
        Text = options.Title or "Nexus UI Window", TextColor3 = self.Colors.Light,
        Font = Enum.Font.GothamBold, TextSize = 16, BackgroundTransparency = 1,
        TextXAlignment = Enum.TextXAlignment.Left, Parent = titleBar
    })
    
    local closeBtn = self:CreateElement("TextButton", {
        Size = UDim2.new(0, 30, 0, 30), Position = UDim2.new(1, -35, 0, 5),
        BackgroundColor3 = self.Colors.Error, Text = "√ó", TextColor3 = self.Colors.Light,
        Font = Enum.Font.GothamBold, TextSize = 20, Parent = titleBar
    }, {
        self:CreateElement("UICorner", {CornerRadius = UDim.new(1, 0)})
    })
    
    -- Add Discord button if link provided
    if options.DiscordLink then
        self:CreateDiscordButton(frame, options.DiscordLink)
    end
    
    self:MakeDraggable(frame, titleBar, guiName)
    self:ApplyButtonEffects(closeBtn)
    
    closeBtn.MouseButton1Click:Connect(function()
        self:CloseWindow(gui)
    end)
    
    window.GUI = gui
    window.Frame = frame
    window.TitleBar = titleBar
    window.Title = title
    window.Name = guiName
    
    table.insert(self.Windows, window)
    
    -- Fade in animation
    if self.options.AnimationEnabled then
        gui.Enabled = false
        frame.BackgroundTransparency = 1
        titleBar.BackgroundTransparency = 1
        title.TextTransparency = 1
        
        task.spawn(function()
            gui.Enabled = true
            self:Tween(frame, self.Animations.FadeIn, {BackgroundTransparency = 0})
            self:Tween(titleBar, self.Animations.FadeIn, {BackgroundTransparency = 0})
            self:Tween(title, self.Animations.FadeIn, {TextTransparency = 0})
        end)
    end
    
    return window
end

-- Utility methods
function NexusUI:Tween(instance, tweenInfo, properties)
    local tween = TweenService:Create(instance, tweenInfo, properties)
    tween:Play()
    return tween
end

function NexusUI:DarkenColor(color, factor)
    return Color3.new(
        math.max(0, color.R * (1 - factor)),
        math.max(0, color.G * (1 - factor)),
        math.max(0, color.B * (1 - factor))
    )
end

function NexusUI:PlaySuccessAnimation(instance)
    if self.options.AnimationEnabled then
        local originalSize = instance.Size
        self:Tween(instance, TweenInfo.new(0.2), {Size = originalSize + UDim2.new(0, 10, 0, 10)})
        self:Tween(instance, TweenInfo.new(0.2, Enum.EasingStyle.Bounce), {Size = originalSize})
    end
end

function NexusUI:PlayErrorAnimation(instance)
    if self.options.AnimationEnabled then
        local originalPosition = instance.Position
        self:Tween(instance, TweenInfo.new(0.1, Enum.EasingStyle.Sine, Enum.EasingDirection.In, 3, true), {
            Position = originalPosition + UDim2.new(0, 5, 0, 0)
        })
    end
end

function NexusUI:CloseWindow(gui)
    if self.options.AnimationEnabled then
        local frame = gui:FindFirstChildOfClass("Frame")
        if frame then
            self:Tween(frame, self.Animations.FadeOut, {BackgroundTransparency = 1})
            task.wait(0.2)
        end
    end
    gui:Destroy()
end

-- Cleanup method
function NexusUI:Destroy()
    for _, component in ip    for _, component in ipairs(self.Components) do
        pcall(function() component:Destroy() end)
    end
    for _, window in ipairs(self.Windows) do
        if window.GUI then
            pcall(function() window.GUI:Destroy() end)
        end
    end
    table.clear(self.Components)
    table.clear(self.Windows)
end

-- Make library global
getgenv().NexusUI = NexusUI
return NexusUI
