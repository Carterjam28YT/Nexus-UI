-- Nexus UI Library (Modified)
local NexusUI = {}
NexusUI.__index = NexusUI

-- Services
local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")

-- Color palette
NexusUI.Colors = {
    Primary = Color3.fromRGB(99, 102, 241),
    PrimaryDark = Color3.fromRGB(79, 70, 229),
    Secondary = Color3.fromRGB(244, 63, 94),
    Dark = Color3.fromRGB(30, 41, 59),
    Darker = Color3.fromRGB(15, 23, 42),
    Light = Color3.fromRGB(248, 250, 252),
    Gray = Color3.fromRGB(100, 116, 139),
    GrayLight = Color3.fromRGB(203, 213, 225),
    Success = Color3.fromRGB(16, 185, 129),
    Warning = Color3.fromRGB(245, 158, 11),
    Error = Color3.fromRGB(239, 68, 68)
}

-- Animations
NexusUI.Animations = {
    ButtonHover = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
    ButtonClick = TweenInfo.new(0.1, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
    FadeIn = TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
    SlideIn = TweenInfo.new(0.4, Enum.EasingStyle.Quart, Enum.EasingDirection.Out)
}

-- Init
function NexusUI:Init(options)
    local self = setmetatable({}, NexusUI)
    self.options = options or {}
    self.Parent = CoreGui
    self.Components = {}
    self.Windows = {}
    self.Verified = false
    self.KeySystemEnabled = options.KeySystem or false
    self.Keys = options.Keys or {}
    self.GetKeyLink = options.GetKeyLink or "https://example.com/getkey"
    return self
end

-- Utility
function NexusUI:CreateElement(className, properties)
    local element = Instance.new(className)
    for property, value in pairs(properties) do
        element[property] = value
    end
    return element
end

-- Key Validation
function NexusUI:ValidateKey(key)
    if not self.KeySystemEnabled then
        self.Verified = true
        return true
    end
    for _, k in ipairs(self.Keys) do
        if key == k then
            self.Verified = true
            return true
        end
    end
    return false
end

-- Key System UI
function NexusUI:CreateKeySystem()
    local gui = self:CreateElement("ScreenGui", {
        Name = "NexusKeySystem",
        DisplayOrder = 999,
        Parent = self.Parent
    })

    local mainFrame = self:CreateElement("Frame", {
        Size = UDim2.new(0, 400, 0, 250),
        Position = UDim2.new(0.5, 0, 0.5, 0),
        AnchorPoint = Vector2.new(0.5, 0.5),
        BackgroundColor3 = self.Colors.Darker,
        Parent = gui
    })
    local corner = self:CreateElement("UICorner", {CornerRadius = UDim.new(0, 16), Parent = mainFrame})

    local title = self:CreateElement("TextLabel", {
        Size = UDim2.new(1, 0, 0, 60),
        BackgroundTransparency = 1,
        Text = "ENTER KEY",
        TextColor3 = self.Colors.Light,
        Font = Enum.Font.GothamBold,
        TextSize = 24,
        Parent = mainFrame
    })

    local keyBox = self:CreateElement("TextBox", {
        Size = UDim2.new(0, 300, 0, 45),
        Position = UDim2.new(0.5, -150, 0.5, -10),
        AnchorPoint = Vector2.new(0.5, 0.5),
        BackgroundColor3 = self.Colors.Dark,
        TextColor3 = self.Colors.Light,
        PlaceholderText = "Enter your key...",
        Font = Enum.Font.Gotham,
        TextSize = 16,
        Text = "",
        Parent = mainFrame
    })
    local keyCorner = self:CreateElement("UICorner", {CornerRadius = UDim.new(0, 8), Parent = keyBox})

    local submit = self:CreateElement("TextButton", {
        Size = UDim2.new(0, 200, 0, 40),
        Position = UDim2.new(0.5, -100, 0.7, 0),
        AnchorPoint = Vector2.new(0.5, 0.5),
        BackgroundColor3 = self.Colors.Primary,
        TextColor3 = self.Colors.Light,
        Text = "SUBMIT",
        Font = Enum.Font.GothamSemibold,
        TextSize = 16,
        Parent = mainFrame
    })
    local submitCorner = self:CreateElement("UICorner", {CornerRadius = UDim.new(0, 8), Parent = submit})

    local getKeyButton = self:CreateElement("TextButton", {
        Size = UDim2.new(0, 120, 0, 30),
        Position = UDim2.new(0.5, -60, 0.85, 0),
        AnchorPoint = Vector2.new(0.5, 0.5),
        BackgroundColor3 = self.Colors.Secondary,
        TextColor3 = self.Colors.Light,
        Text = "GET KEY",
        Font = Enum.Font.GothamBold,
        TextSize = 14,
        Parent = mainFrame
    })
    local getCorner = self:CreateElement("UICorner", {CornerRadius = UDim.new(0, 6), Parent = getKeyButton})

    getKeyButton.MouseButton1Click:Connect(function()
        if self.GetKeyLink then
            if setclipboard then setclipboard(self.GetKeyLink) end
        end
    end)

    local resultLabel = self:CreateElement("TextLabel", {
        Size = UDim2.new(1, -20, 0, 30),
        Position = UDim2.new(0, 10, 0, 200),
        BackgroundTransparency = 1,
        Text = "",
        TextColor3 = self.Colors.Error,
        Font = Enum.Font.Gotham,
        TextSize = 14,
        TextWrapped = true,
        Parent = mainFrame
    })

    local function submitKey()
        local key = keyBox.Text
        if self:ValidateKey(key) then
            resultLabel.Text = "✅ Key validated!"
            resultLabel.TextColor3 = self.Colors.Success
            task.wait(0.5)
            gui:Destroy()
            return true
        else
            resultLabel.Text = "❌ Invalid key!"
            resultLabel.TextColor3 = self.Colors.Error
        end
    end

    submit.MouseButton1Click:Connect(submitKey)
    keyBox.FocusLost:Connect(function(enter)
        if enter then submitKey() end
    end)

    -- Draggable frame
    local dragging = false
    local dragInput, mousePos, framePos
    mainFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            mousePos = input.Position
            framePos = mainFrame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then dragging = false end
            end)
        end
    end)
    mainFrame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then dragInput = input end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - mousePos
            mainFrame.Position = UDim2.new(framePos.X.Scale, framePos.X.Offset + delta.X, framePos.Y.Scale, framePos.Y.Offset + delta.Y)
        end
    end)

    table.insert(self.Components, gui)
    return gui
end

-- Example Window creation (will only show after key validated)
function NexusUI:CreateWindow(options)
    if self.KeySystemEnabled and not self.Verified then
        self:CreateKeySystem()
        repeat task.wait() until self.Verified
    end

    local window = {
        Name = options.Name or "Nexus UI",
        Tabs = {},
    }

    -- Main window
    local screenGui = self:CreateElement("ScreenGui", {Name = "NexusWindow", DisplayOrder = 10, Parent = self.Parent})
    local mainFrame = self:CreateElement("Frame", {
        Size = UDim2.new(0, 600, 0, 400),
        Position = UDim2.new(0.5, 0, 0.5, 0),
        AnchorPoint = Vector2.new(0.5, 0.5),
        BackgroundColor3 = self.Colors.Darker,
        Parent = screenGui
    })
    local corner = self:CreateElement("UICorner", {CornerRadius = UDim.new(0, 12), Parent = mainFrame})

    -- Close button
    local closeButton = self:CreateElement("TextButton", {
        Size = UDim2.new(0, 25, 0, 25),
        Position = UDim2.new(1, -30, 0, 5),
        BackgroundColor3 = self.Colors.Error,
        TextColor3 = self.Colors.Light,
        Text = "X",
        Font = Enum.Font.GothamBold,
        TextSize = 18,
        AutoButtonColor = false,
        Parent = mainFrame
    })
    local closeCorner = self:CreateElement("UICorner", {CornerRadius = UDim.new(0, 6), Parent = closeButton})
    closeButton.MouseButton1Click:Connect(function()
        screenGui.Enabled = false
    end)

    -- Draggable
    local dragging = false
    local dragInput, mousePos, framePos
    mainFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            mousePos = input.Position
            framePos = mainFrame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then dragging = false end
            end)
        end
    end)
    mainFrame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then dragInput = input end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - mousePos
            mainFrame.Position = UDim2.new(framePos.X.Scale, framePos.X.Offset + delta.X, framePos.Y.Scale, framePos.Y.Offset + delta.Y)
        end
    end)

    table.insert(self.Windows, window)
    window.GUI = screenGui
    return window
end

-- Make library global
getgenv().NexusUI = NexusUI
return NexusUI
